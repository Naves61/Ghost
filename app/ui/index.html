<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Ghost Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --muted:#666; --chip:#eef; --accent:#444; --border:#e5e7eb; }
    body { background: var(--bg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 24px; color:#111; }
    h1 { margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; align-items: start; }
    .card { border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; background: var(--card); box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .row { display: flex; gap: 12px; align-items: center; }
    .tag { display:inline-block; padding: 2px 8px; border-radius: 999px; background: var(--chip); font-size: 12px; color:#223; margin-right:6px; }
    .muted { color: var(--muted); font-size: 12px; }
    .thought { margin-bottom: 10px; }
    .thought p { margin: 4px 0; }
    label { font-size: 12px; color: var(--muted); }
    input[type="text"], textarea { width: 100%; border:1px solid var(--border); border-radius:8px; padding:8px; font-size:14px; }
    button { border:1px solid var(--border); border-radius:8px; padding:8px 12px; background:#111; color:#fff; cursor:pointer; }
    button.secondary { background:#fff; color:#111; }
    form { display: grid; gap: 8px; }
    pre { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  </style>
</head>
<body>
  <h1>Ghost Dashboard</h1>
  <div class="grid">
    <div class="card">
      <h3>Working Memory</h3>
      <div id="wm"></div>
    </div>

    <div class="card">
      <h3>Long-Term Memory</h3>
      <div id="ltm"></div>
    </div>

    <div class="card">
      <h3>Attention</h3>
      <div id="attn"></div>
      <hr/>
      <h4>Pending Interrupts</h4>
      <div id="ints"></div>
      <h4>Answer Interrupt</h4>
      <form id="answerForm">
        <label>Interrupt ID</label>
        <input id="qid" type="text" placeholder="q:..."/>
        <label>Answer</label>
        <textarea id="answer" rows="3" placeholder="Type your answer"></textarea>
        <button type="submit">Submit Answer</button>
      </form>
      <hr/>
      <h4>Controls</h4>
      <div class="two">
        <form id="availForm">
          <label>User Available?</label>
          <select id="available">
            <option value="true">Yes</option>
            <option value="false">No (auto-escalate)</option>
          </select>
          <button type="submit" class="secondary">Set</button>
        </form>
        <form id="socForm">
          <label>SoC Cadence (s)</label>
          <input id="socCadence" type="number" min="1" step="1"/>
          <button type="submit" class="secondary">Set</button>
        </form>
      </div>
      <form id="scrapeForm">
        <label>Scrape: Question</label>
        <input id="scrapeQ" type="text" placeholder="What to research"/>
        <label>Seeds (comma-separated URLs)</label>
        <input id="scrapeSeeds" type="text" placeholder="https://example.com, https://example.com/page"/>
        <button type="submit">Run Scrape</button>
      </form>
      <hr/>
      <h4>Force Stimulus</h4>
      <form id="stimForm">
        <label>Source</label>
        <input id="stimSource" type="text" placeholder="ui" value="ui"/>
        <label>Content</label>
        <textarea id="stimContent" rows="2" placeholder="Stimulus text"></textarea>
        <button type="submit">Send Stimulus</button>
      </form>
      <div class="muted" id="cfg"></div>
    </div>
  </div>

  <script>
    async function getJSON(url) { const r = await fetch(url); return r.json(); }
    async function post(url, params) {
      const form = new URLSearchParams(params);
      const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form});
      return r.json();
    }

    function fmtTime(ts) {
      if (!ts) return '';
      const d = new Date(ts*1000);
      return d.toLocaleTimeString();
    }

    function renderWM(items) {
      const el = document.getElementById('wm');
      el.innerHTML = items.map(t => `
        <div class="thought">
          <span class="tag">${t.tags.join(", ")}</span>
          <span class="muted">${fmtTime(t.ts)}</span>
          <p>${t.content.replace(/^#(plan|question|insight)\s*/,'')}</p>
        </div>
      `).join("") || '<div class="muted">Empty</div>';
    }

    function renderLTM(items) {
      const el = document.getElementById('ltm');
      el.innerHTML = items.map(m => `
        <div class="thought">
          <span class="muted">${m.type}</span>
          <p>${m.content}</p>
        </div>
      `).join("") || '<div class="muted">Empty</div>';
    }

    function renderInts(items) {
      const el = document.getElementById('ints');
      el.innerHTML = items.map(q => `
        <div class="thought">
          <b>${q.id}</b> <span class="muted">${fmtTime(q.created_ts)}</span>
          <p><i>${q.rationale}</i></p>
          <p>${q.question}</p>
        </div>
      `).join("") || '<div class="muted">None</div>';
    }

    function renderAttn(items) {
      const el = document.getElementById('attn');
      el.innerHTML = items.map(it => `
        <div class="thought">
          <b>${it.task.id}</b> <span class="muted">${it.score.toFixed(2)}</span>
          <p>${it.task.title || ''}</p>
        </div>
      `).join("") || '<div class="muted">None</div>';
    }

    async function refresh() {
      const [wm, ltm, ints, attn, cfg] = await Promise.all([
        getJSON('/wm'),
        getJSON('/ltm/recent'),
        getJSON('/interrupts'),
        getJSON('/tasks/top'),
        getJSON('/config'),
      ]);
      renderWM(wm);
      renderLTM(ltm);
      renderInts(ints);
      renderAttn(attn);
      document.getElementById('cfg').textContent = `Availability: ${cfg.user_available ? 'Yes' : 'No'} | SoC: ${cfg.soc_cadence}s | Allowlist: ${cfg.allowlist.join(', ')}`;
      document.getElementById('available').value = String(cfg.user_available);
      document.getElementById('socCadence').value = cfg.soc_cadence;
    }

    // Forms
    document.getElementById('answerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const qid = document.getElementById('qid').value.trim();
      const text = document.getElementById('answer').value.trim();
      if (!qid || !text) return;
      await post(`/interrupts/answer?qid=${encodeURIComponent(qid)}&text=${encodeURIComponent(text)}`, {});
      document.getElementById('answer').value = '';
      await refresh();
    });

    document.getElementById('availForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const available = document.getElementById('available').value === 'true';
      await post(`/config/user_available?available=${available}`, {});
      await refresh();
    });

    document.getElementById('socForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const seconds = parseInt(document.getElementById('socCadence').value, 10);
      if (!seconds || seconds <= 0) return;
      await post(`/config/soc_cadence?seconds=${seconds}`, {});
      await refresh();
    });

    document.getElementById('scrapeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = document.getElementById('scrapeQ').value.trim();
      const seeds = document.getElementById('scrapeSeeds').value.trim();
      if (!q || !seeds) return;
      await post(`/scrape?question=${encodeURIComponent(q)}&seeds_csv=${encodeURIComponent(seeds)}`, {});
      document.getElementById('scrapeQ').value = '';
      document.getElementById('scrapeSeeds').value = '';
      await refresh();
    });

    document.getElementById('stimForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const source = document.getElementById('stimSource').value.trim() || 'ui';
      const content = document.getElementById('stimContent').value.trim();
      if (!content) return;
      await fetch('/stimuli', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify([{source, content}]),
      });
      document.getElementById('stimContent').value = '';
      await refresh();
    });

    refresh(); setInterval(refresh, 4000);
  </script>
</body>
</html>